<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Cifrado End-to-End</title>
    <script src="https://unpkg.com/tweetnacl@1.0.3/nacl-fast.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        input, textarea, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #444;
            border-radius: 5px;
            background: #333;
            color: #fff;
        }
        button {
            background: #007bff;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
        }
        .success {
            background: #28a745;
        }
        .error {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <h1>üîê Test de Cifrado End-to-End</h1>
    
    <div class="container">
        <h2>1. Generar Claves</h2>
        <button onclick="generateKeys()">Generar Par de Claves</button>
        <div id="keys-result"></div>
    </div>

    <div class="container">
        <h2>2. Cifrar Mensaje</h2>
        <textarea id="message" placeholder="Escribe tu mensaje aqu√≠..." rows="3"></textarea>
        <button onclick="encryptMessage()">Cifrar Mensaje</button>
        <div id="encrypt-result"></div>
    </div>

    <div class="container">
        <h2>3. Descifrar Mensaje</h2>
        <textarea id="encrypted-message" placeholder="Pega el mensaje cifrado aqu√≠..." rows="3"></textarea>
        <button onclick="decryptMessage()">Descifrar Mensaje</button>
        <div id="decrypt-result"></div>
    </div>

    <div class="container">
        <h2>4. Test Autom√°tico</h2>
        <button onclick="runAutoTest()">Ejecutar Test Completo</button>
        <div id="auto-test-result"></div>
    </div>

    <script>
        // Base58 implementation
        const BASE58_ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';

        function base58Encode(bytes) {
            if (bytes.length === 0) return '';
            
            let digits = [0];
            for (let i = 0; i < bytes.length; i++) {
                let carry = bytes[i];
                for (let j = 0; j < digits.length; j++) {
                    carry += digits[j] << 8;
                    digits[j] = carry % 58;
                    carry = Math.floor(carry / 58);
                }
                while (carry > 0) {
                    digits.push(carry % 58);
                    carry = Math.floor(carry / 58);
                }
            }
            
            let leadingZeros = 0;
            for (let i = 0; i < bytes.length && bytes[i] === 0; i++) {
                leadingZeros++;
            }
            
            return '1'.repeat(leadingZeros) + digits.reverse().map(d => BASE58_ALPHABET[d]).join('');
        }

        function base58Decode(str) {
            if (str.length === 0) return new Uint8Array(0);
            
            let bytes = [0];
            for (let i = 0; i < str.length; i++) {
                const char = str[i];
                const charIndex = BASE58_ALPHABET.indexOf(char);
                if (charIndex === -1) throw new Error('Invalid Base58 character');
                
                let carry = charIndex;
                for (let j = 0; j < bytes.length; j++) {
                    carry += bytes[j] * 58;
                    bytes[j] = carry & 0xff;
                    carry >>= 8;
                }
                while (carry > 0) {
                    bytes.push(carry & 0xff);
                    carry >>= 8;
                }
            }
            
            let leadingOnes = 0;
            for (let i = 0; i < str.length && str[i] === '1'; i++) {
                leadingOnes++;
            }
            
            const result = new Uint8Array(leadingOnes + bytes.length);
            result.set(bytes.reverse(), leadingOnes);
            return result;
        }

        // Global variables for keys
        let senderKeyPair = null;
        let recipientKeyPair = null;

        function generateKeys() {
            senderKeyPair = nacl.box.keyPair();
            recipientKeyPair = nacl.box.keyPair();
            
            const result = `
                <div class="result success">
                    <h3>‚úÖ Claves generadas exitosamente</h3>
                    <p><strong>Clave P√∫blica Emisor:</strong> ${base58Encode(senderKeyPair.publicKey)}</p>
                    <p><strong>Clave P√∫blica Receptor:</strong> ${base58Encode(recipientKeyPair.publicKey)}</p>
                    <p><em>Las claves privadas se mantienen seguras en memoria</em></p>
                </div>
            `;
            document.getElementById('keys-result').innerHTML = result;
        }

        function encryptMessage() {
            if (!senderKeyPair || !recipientKeyPair) {
                document.getElementById('encrypt-result').innerHTML = 
                    '<div class="result error">‚ùå Primero genera las claves</div>';
                return;
            }

            const message = document.getElementById('message').value;
            if (!message.trim()) {
                document.getElementById('encrypt-result').innerHTML = 
                    '<div class="result error">‚ùå Escribe un mensaje para cifrar</div>';
                return;
            }

            try {
                const messageBytes = new TextEncoder().encode(message);
                const nonce = nacl.randomBytes(24);
                const encrypted = nacl.box(messageBytes, nonce, recipientKeyPair.publicKey, senderKeyPair.secretKey);
                
                const combined = new Uint8Array(nonce.length + encrypted.length);
                combined.set(nonce);
                combined.set(encrypted, nonce.length);
                
                const encryptedBase58 = base58Encode(combined);
                
                const result = `
                    <div class="result success">
                        <h3>‚úÖ Mensaje cifrado exitosamente</h3>
                        <p><strong>Mensaje original:</strong> ${message}</p>
                        <p><strong>Mensaje cifrado:</strong> ${encryptedBase58}</p>
                        <p><strong>Longitud:</strong> ${encryptedBase58.length} caracteres</p>
                    </div>
                `;
                document.getElementById('encrypt-result').innerHTML = result;
                document.getElementById('encrypted-message').value = encryptedBase58;
            } catch (error) {
                document.getElementById('encrypt-result').innerHTML = 
                    `<div class="result error">‚ùå Error cifrando: ${error.message}</div>`;
            }
        }

        function decryptMessage() {
            if (!senderKeyPair || !recipientKeyPair) {
                document.getElementById('decrypt-result').innerHTML = 
                    '<div class="result error">‚ùå Primero genera las claves</div>';
                return;
            }

            const encryptedMessage = document.getElementById('encrypted-message').value;
            if (!encryptedMessage.trim()) {
                document.getElementById('decrypt-result').innerHTML = 
                    '<div class="result error">‚ùå Pega un mensaje cifrado</div>';
                return;
            }

            try {
                const combined = base58Decode(encryptedMessage);
                const nonce = combined.slice(0, 24);
                const encrypted = combined.slice(24);
                
                const decrypted = nacl.box.open(encrypted, nonce, senderKeyPair.publicKey, recipientKeyPair.secretKey);
                if (!decrypted) throw new Error('Descifrado fall√≥');
                
                const decryptedMessage = new TextDecoder().decode(decrypted);
                
                const result = `
                    <div class="result success">
                        <h3>‚úÖ Mensaje descifrado exitosamente</h3>
                        <p><strong>Mensaje descifrado:</strong> ${decryptedMessage}</p>
                    </div>
                `;
                document.getElementById('decrypt-result').innerHTML = result;
            } catch (error) {
                document.getElementById('decrypt-result').innerHTML = 
                    `<div class="result error">‚ùå Error descifrando: ${error.message}</div>`;
            }
        }

        function runAutoTest() {
            const testMessages = [
                "Hola mundo! üåç",
                "Este es un mensaje de prueba con caracteres especiales: √°√©√≠√≥√∫ √±",
                "Test con n√∫meros: 123456789 y s√≠mbolos: !@#$%^&*()",
                "Mensaje largo: " + "A".repeat(1000)
            ];

            let results = '<div class="result"><h3>üß™ Ejecutando Tests Autom√°ticos</h3>';
            let allPassed = true;

            // Generate keys for test
            const testSenderKeyPair = nacl.box.keyPair();
            const testRecipientKeyPair = nacl.box.keyPair();

            testMessages.forEach((message, index) => {
                try {
                    // Encrypt
                    const messageBytes = new TextEncoder().encode(message);
                    const nonce = nacl.randomBytes(24);
                    const encrypted = nacl.box(messageBytes, nonce, testRecipientKeyPair.publicKey, testSenderKeyPair.secretKey);
                    
                    const combined = new Uint8Array(nonce.length + encrypted.length);
                    combined.set(nonce);
                    combined.set(encrypted, nonce.length);
                    
                    const encryptedBase58 = base58Encode(combined);

                    // Decrypt
                    const combinedDecrypt = base58Decode(encryptedBase58);
                    const nonceDecrypt = combinedDecrypt.slice(0, 24);
                    const encryptedDecrypt = combinedDecrypt.slice(24);
                    
                    const decrypted = nacl.box.open(encryptedDecrypt, nonceDecrypt, testSenderKeyPair.publicKey, testRecipientKeyPair.secretKey);
                    const decryptedMessage = new TextDecoder().decode(decrypted);

                    if (decryptedMessage === message) {
                        results += `<p>‚úÖ Test ${index + 1}: PAS√ì (${message.length} chars)</p>`;
                    } else {
                        results += `<p>‚ùå Test ${index + 1}: FALL√ì - Mensaje no coincide</p>`;
                        allPassed = false;
                    }
                } catch (error) {
                    results += `<p>‚ùå Test ${index + 1}: ERROR - ${error.message}</p>`;
                    allPassed = false;
                }
            });

            results += `<h3>${allPassed ? 'üéâ Todos los tests pasaron!' : '‚ö†Ô∏è Algunos tests fallaron'}</h3></div>`;
            document.getElementById('auto-test-result').innerHTML = results;
        }

        // Generate keys on page load
        window.onload = function() {
            generateKeys();
        };
    </script>
</body>
</html>