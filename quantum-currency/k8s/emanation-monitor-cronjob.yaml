apiVersion: batch/v1
kind: CronJob
metadata:
  name: quantum-currency-emanation-monitor
  namespace: quantum-currency
  labels:
    app: quantum-currency
    component: emanation-monitor
spec:
  schedule: "*/15 * * * *"  # Run every 15 minutes
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 5
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: quantum-currency
            component: emanation-monitor
        spec:
          serviceAccountName: quantum-currency-monitor
          containers:
          - name: emanation-monitor
            image: quantumcurrency/emanation-monitor:latest
            imagePullPolicy: IfNotPresent
            command:
            - python3
            - emanation_deploy.py
            - --cycles
            - "1"
            - --interval
            - "0"
            - --report-dir
            - /mnt/data
            - --prometheus-url
            - http://prometheus.quantum-currency.svc.cluster.local:9090
            env:
            - name: QUANTUM_ENV
              value: "production"
            - name: PYTHONPATH
              value: "src"
            - name: LOG_LEVEL
              value: "INFO"
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: slack-webhook
                  key: url
                  optional: true
            - name: ALERT_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: alert-webhook
                  key: url
                  optional: true
            volumeMounts:
            - name: data-volume
              mountPath: /mnt/data
            resources:
              requests:
                memory: "256Mi"
                cpu: "250m"
              limits:
                memory: "512Mi"
                cpu: "500m"
            livenessProbe:
              exec:
                command:
                - python3
                - -c
                - "import os; exit(0) if os.path.exists('/tmp/monitor_healthy') else exit(1)"
              initialDelaySeconds: 60
              periodSeconds: 30
            readinessProbe:
              exec:
                command:
                - python3
                - -c
                - "import os; exit(0) if os.path.exists('/tmp/monitor_ready') else exit(1)"
              initialDelaySeconds: 30
              periodSeconds: 10
          volumes:
          - name: data-volume
            persistentVolumeClaim:
              claimName: quantum-currency-data-pvc
          restartPolicy: OnFailure
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: quantum-currency-monitor
  namespace: quantum-currency
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: quantum-currency
  name: monitor-role
rules:
- apiGroups: [""]
  resources: ["pods", "services"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: quantum-currency-monitor-rolebinding
  namespace: quantum-currency
subjects:
- kind: ServiceAccount
  name: quantum-currency-monitor
  namespace: quantum-currency
roleRef:
  kind: Role
  name: monitor-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: Secret
metadata:
  name: slack-webhook
  namespace: quantum-currency
type: Opaque
data:
  # Base64 encoded webhook URL - replace with actual value
  url: aHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2VydmljZXMvVEgxMjM0NTY3ODkwL3Rlc3Q=  # https://hooks.slack.com/services/TH1234567890/test
---
apiVersion: v1
kind: Secret
metadata:
  name: alert-webhook
  namespace: quantum-currency
type: Opaque
data:
  # Base64 encoded webhook URL - replace with actual value
  url: aHR0cHM6Ly93d3cuZXhhbXBsZS5jb20vYWxlcnQ=  # https://www.example.com/alert